#textdomain wesnoth-ah

[scenario]
    id=08_Ilrandh
    name= _ "Ilrandh"
    next_scenario=09_Epilogue
    # Insert the content of the file pointed to at this position.
    map_file=08_Ilrandh.map
    snapshot=no
    {ASHEN_HEARTS_XP_MODIFIER}

    # load the macros at top level
    {./scenario-utils/08_Ilrandh-utils.cfg}

    {SCENARIO_MUSIC battle-epic.ogg}
    {EXTRA_SCENARIO_MUSIC legends_of_the_north.ogg}
    {EXTRA_SCENARIO_MUSIC northern_mountains.ogg}

    ##::Story
    {AH_STORY_ILRANDH}

    # Number of turns
    turns=-1

    # The player wins if all enemy leaders are dead.
    victory_when_enemies_defeated=no

    ##|| Flow Of Time ||##
    {PRESENCE_OF_THE_DRAGONHEART}

    ##|| Determine Side Conditions ||##
    ##|| Player Side
    [side]
        {HERKARTH_SIDE}

        ##:: Gold and Income
        {GOLD 360 340 320}
        {INCOME 2 2 1}
    [/side]

    ##|| Friend
    [side]
        ##:: Side Info
        side=2
        controller=ai
        {TEAM_NAME:ALLY}

        ##:: Leader Info
        {AH_CHARACTER_STATS:MENOR}
        
        [ai]
            grouping="defensive"
            leader_aggression=-20
            aggression=0.8
            passive_leader=yes
            passive_leader_shares_keep=yes

            [goal]
                name=protect_unit
                [criteria]
                    id=Menor IV
                [/criteria]
                protect_radius=5
                value=100
            [/goal]
        [/ai]

        ##:: Recruit List
        recruit=Drake Arbiter, Drake Thrasher, Fire Drake, Drake Warrior

        ##:: Gold and Income
        {GOLD 340 320 300}
        {INCOME 12 10 10}
    [/side]

    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 ("Fire Drake") ({ON_DIFFICULTY 4 3 3})}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 ("Drake Warrior") ({ON_DIFFICULTY 7 6 5})}

    ##|| Ilrandh, the Dwarven King
    [side]
        ##:: Side Info
        side=3
        controller=ai
        {TEAM_NAME:DWARVES}
        color=gold

        ##:: Leader Info
        {AH_CHARACTER_STATS:ILRANDH}

        ##:: Recruit List
        recruit=

        ##:: Economy
        gold=0
        income=-2
        village_gold=0
        village_support=2

        [ai]
            aggression=1.0
            village_value=0
            scout_village_targeting=0
            villages_per_scout=0

            leader_aggression=1
            leader_ignores_keep=yes
            grouping="offensive"

            [goal]
                name=target
                [criteria]
                    # simply let side 3 force grind side 2 force down
                    #id=Menor IV
                    side = 2
                [/criteria]
                value=50
            [/goal]
            # overcoded. Conflict with protection from micro_ai from loyal dwarves
            # Ilrandh has crown and bodyguards. He needs to move to Menor castle instead of protection
            #[goal]
            #    name=protect_unit
            #	[criteria]
            #		id=Ilrandh
            #	[/criteria]
            #	protect_radius=10
            #	value=25
            #[/goal]

            # giving leader_goal here caused an error. Using micro ai instead
        [/ai]

        ##:: Gold and Income
        {GOLD 120 130 140}
        {INCOME 0 0 0}
    [/side]

    ##|| Skjal, the Arcanister
    [side]
        ##:: Side Info
        side=4
        controller=ai
        {TEAM_NAME:DWARVES}

        ##:: Leader Info
        type=Dwarvish Arcanister
        id=Skjal
        name=Skjal
        canrecruit=yes
        unrenamable=yes

        ##:: Recruit List
        recruit="Dwarvish Stalwart, Dwarvish Sentinel, Dwarvish Steelclad, Dwarvish Thunderguard, Dwarvish Dragonguard, Bear Rider"

        ##:: Gold and Income
        {GOLD 160 180 200}
        {INCOME 0 1 2}

        # give village to side 4
        [village]
            x=20
            y=54
        [/village]
        [village]
            x=22
            y=52
        [/village]
        [village]
            x=28
            y=52
        [/village]
        [village]
            x=30
            y=54
        [/village]
    [/side]

    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 ("Bear Rider") ({ON_DIFFICULTY 2 3 3})}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 ("Dwarvish Dragonguard") ({ON_DIFFICULTY 1 2 2})}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 ("Dwarvish Sentinel") ({ON_DIFFICULTY 1 2 2})}

    ##:: event prestart
    [event]
        name=prestart

        {ASHEN_HEART_RECALL_COSTS_ADJUSTMENT}

        {CAPTURE_VILLAGES 2 24 13 20 }

        {LOOT_CHEST_OF_GOLD 1 75 38 66}
        {LOOT_CHEST_OF_GOLD 1 75 20 65}

        {LOYAL_UNIT 2 (Drake Warden) 21 16}
        {LOYAL_UNIT 2 (Drake Warden) 30 15}
        {LOYAL_UNIT 2 (Drake Warden) 25 11}

        [modify_unit]
            [filter]
                type=Drake Warden
                side=2
            [/filter]
            [status]
                guardian=yes
            [/status]
        [/modify_unit]

        ##::Lava outbursts
        {LAVA_OUTBURST 21 67}
        {LAVA_OUTBURST 33 65}
        {LAVA_OUTBURST 29 55}
        {LAVA_OUTBURST 23 53}
        {LAVA_OUTBURST 12 46}
        {LAVA_OUTBURST 25 53}
        {LAVA_OUTBURST 35 42}
        {LAVA_OUTBURST 27 38}
        {LAVA_OUTBURST 19 37}
        {LAVA_OUTBURST 23 34}
        {LAVA_OUTBURST 31 36}

        {LAVA_OUTBURST 24 19}
        {LAVA_OUTBURST 20 13}
        {LAVA_OUTBURST 29 17}

        {SOUL_GEM 25 14}

        # an old keep of some drakes rebel in scenario 1
        [item]
            x,y=21,26
            image=terrain/troll/keep-oldAH.png
        [/item]

        ##::speedrunes that the dwarves used to quickly get to the Ashen's Maw (can be used by drakes to get to Ilrandh quickly)
        # This would be used by drakes mostly since they were faster.

        {SPEED_RUNE 37 71 }
        {SPEED_RUNE 30 67 }
        {SPEED_RUNE 27 70 }
        {SPEED_RUNE 20 58 }
        {SPEED_RUNE 30 58 }
        {SPEED_RUNE 27 64 }
        {SPEED_RUNE 35 53 }
        {SPEED_RUNE 16 52 }

        ##::micro

        # If AI step on wind runes, charge at player
        [micro_ai]
            side=4
            ai_type=goto
            action=add
            ca_score=110001

            [filter]
                side=4
                [filter_location]
                    x=37,27,20,30,27,35,16
                    y=71,70,58,58,64,53,52
                [/filter_location]
            [/filter]

            [filter_location]
                [filter]
                    side=1
                [/filter]
                radius=1
            [/filter_location]
        [/micro_ai]

        # Clockwork Centurion did not exist, side 3 could recuit clockwork ballista
        # add Clockwork Centurions incase of playing HARD
        [micro_ai]
            side=3
            ai_type=goto
            action=add
            ca_score=130000

            [filter]
                type=Bear Cavalry, Clockwork Centurion
            [/filter]

            [filter_location]
                [filter]
                    id=Ilrandh
                [/filter]
                radius=1
            [/filter_location]
        [/micro_ai]

        # these bodyguards were good but not necessary since side 3 leader had the crown.
        # the paths also were narrow. There was no way they could form formation, but zombie pack
        [micro_ai]
            side=3
            ai_type=goto
            action=add
            ca_score=129000

            [filter]
                type=Dwarvish Dragonguard
            [/filter]

            [filter_location]
                [filter]
                    id=Ilrandh
                [/filter]
                radius=2
            [/filter_location]
        [/micro_ai]

        # give leader goal since giving it in side tag caused conflict with other goal tag or something
        [micro_ai]
            side=3
            ai_type=goto
            action=add
            ca_score=300000
            [filter]
                id=Ilrandh
            [/filter]
            # move to north of stone instead. It bugged when AI tried to move to impossible tile
            [filter_location]
                x,y=25,13
            [/filter_location]
            # original max_risk is 80% but let's him charge since only Khazran can kill him
            ignore_enemy_at_goal=yes
            ignore_units=yes
            # keep finding new route if allies block him
            remove_movement=no
        [/micro_ai]

        ##::special item for ilrandh
        [object]
            duration=forever
            silent=yes
            [filter]
                id=Ilrandh
            [/filter]
            [effect]
                apply_to=new_ability
                [abilities]
                    [underearth_crown]
                        id=king
                        name= _ "Bearer of the Underearth Crown"
                        description=_ "This unit is nearly immortal. Only the mightiest beings could hope to harm him."
                    [/underearth_crown]
                [/abilities]
            [/effect]
            [effect]
                apply_to=movement
                set=3
            [/effect]
            [effect]
                apply_to=hitpoints
                increase_total=46
                heal_full=yes
            [/effect]
            [effect]
                apply_to=max_experience
                increase=800
            [/effect]
        [/object]

        ##::runes
        # This was a tunnel but for performance, it would be simply moveto event.
        {PLACE_IMAGE scenery/rune3-glow.png 25 51}
        {PLACE_IMAGE scenery/rune3-glow.png 25 54}

        ##::front row
        {GENERIC_UNIT 3 (Dwarvish Protector) 26 47}
        {GENERIC_UNIT 3 (Dwarvish Protector) 27 48}
        {GENERIC_UNIT 3 (Dwarvish Protector) 28 47}
        {GENERIC_UNIT 3 (Dwarvish Protector) 29 48}

        {GENERIC_UNIT 3 (Dwarvish Protector) 24 47}
        {GENERIC_UNIT 3 (Dwarvish Protector) 23 48}
        {GENERIC_UNIT 3 (Dwarvish Protector) 22 47}
        {GENERIC_UNIT 3 (Dwarvish Protector) 21 48}
#ifdef EASY
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 26 48}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 27 49}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 28 48}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 29 49}

        {GENERIC_UNIT 3 (Dwarvish Steelclad) 24 48}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 23 49}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 22 48}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 21 49}

        {GENERIC_UNIT 3 (Clockwork Ballista) 22 50}
        {GENERIC_UNIT 3 (Clockwork Ballista) 28 50}
#else
        {GENERIC_UNIT 3 (Dwarvish Lord) 26 48}
        {GENERIC_UNIT 3 (Dwarvish Lord) 27 49}
        {GENERIC_UNIT 3 (Dwarvish Lord) 28 48}
        {GENERIC_UNIT 3 (Dwarvish Lord) 29 49}

        {GENERIC_UNIT 3 (Dwarvish Lord) 24 48}
        {GENERIC_UNIT 3 (Dwarvish Lord) 23 49}
        {GENERIC_UNIT 3 (Dwarvish Lord) 22 48}
        {GENERIC_UNIT 3 (Dwarvish Lord) 21 49}

        {GENERIC_UNIT 3 (Clockwork Centurion) 22 50}
        {GENERIC_UNIT 3 (Clockwork Centurion) 28 50}
#endif

        ##::left flank
        {GENERIC_UNIT 3 (Dwarvish Protector) 18 48}
        {GENERIC_UNIT 3 (Dwarvish Protector) 17 49}
        {GENERIC_UNIT 3 (Dwarvish Protector) 16 49}
        {GENERIC_UNIT 3 (Dwarvish Protector) 15 50}
#ifdef EASY
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 18 49}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 17 50}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 16 50}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 15 51}

        {GENERIC_UNIT 3 (Clockwork Ballista) 16 51}
        {GENERIC_UNIT 3 (Clockwork Ballista) 19 50}
#else
        {GENERIC_UNIT 3 (Dwarvish Lord) 18 49}
        {GENERIC_UNIT 3 (Dwarvish Lord) 17 50}
        {GENERIC_UNIT 3 (Dwarvish Lord) 16 50}
        {GENERIC_UNIT 3 (Dwarvish Lord) 15 51}

        {GENERIC_UNIT 3 (Clockwork Centurion) 16 51}
        {GENERIC_UNIT 3 (Clockwork Centurion) 19 50}
#endif

        ##::right flank
        {GENERIC_UNIT 3 (Dwarvish Protector) 32 48}
        {GENERIC_UNIT 3 (Dwarvish Protector) 33 49}
        {GENERIC_UNIT 3 (Dwarvish Protector) 34 49}
        {GENERIC_UNIT 3 (Dwarvish Protector) 35 50}
#ifdef EASY
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 32 49}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 33 50}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 34 50}
        {GENERIC_UNIT 3 (Dwarvish Steelclad) 35 51}

        {GENERIC_UNIT 3 (Clockwork Ballista) 34 51}
        {GENERIC_UNIT 3 (Clockwork Ballista) 31 50}
#else
        {GENERIC_UNIT 3 (Dwarvish Lord) 32 49}
        {GENERIC_UNIT 3 (Dwarvish Lord) 33 50}
        {GENERIC_UNIT 3 (Dwarvish Lord) 34 50}
        {GENERIC_UNIT 3 (Dwarvish Lord) 35 51}

        {GENERIC_UNIT 3 (Clockwork Centurion) 34 51}
        {GENERIC_UNIT 3 (Clockwork Centurion) 31 50}
#endif

        {NAMED_LOYAL_UNIT 3 (Dwarvish Dragonguard) 18 51 Krindil _"Krindil"}
        {NAMED_LOYAL_UNIT 3 (Dwarvish Dragonguard) 32 51 Elqadil _"Elqadil"}
        {NAMED_LOYAL_UNIT 3 (Bear Cavalry) 22 49 Corrondil _"Corrondil"}
        {NAMED_LOYAL_UNIT 3 (Bear Cavalry) 28 49 Percatdol _"Percatdol"}
        {NAMED_LOYAL_UNIT 3 (Dwarvish Bloodaxe) 11 50 Kerdin _"Kerdin"}

        {NAMED_LOYAL_UNIT 3 (Bear Cavalry) 24 55 Cent1 _"Crowndil"}
        {NAMED_LOYAL_UNIT 3 (Bear Cavalry) 26 55 Cent2 _"Heirdil"}

        ##::bodyguards
#ifdef EASY
        {GENERIC_UNIT 4 (Clockwork Ballista) 21 57}
        {GENERIC_UNIT 4 (Clockwork Ballista) 20 56}
        {GENERIC_UNIT 4 (Clockwork Ballista) 29 57}
        {GENERIC_UNIT 4 (Clockwork Ballista) 30 56}
#else
        {GENERIC_UNIT 4 (Clockwork Centurion) 21 57}
        {GENERIC_UNIT 4 (Clockwork Centurion) 20 56}
        {GENERIC_UNIT 4 (Clockwork Centurion) 29 57}
        {GENERIC_UNIT 4 (Clockwork Centurion) 30 56}
#endif
        {MODIFY_UNIT (x,y=14-24,46-65) facing sw}
        {MODIFY_UNIT (x,y=26-35,46-65) facing se}

        {SKJAL_GUARDIAN 21 57}
        {SKJAL_GUARDIAN 20 56}
        {SKJAL_GUARDIAN 29 57}
        {SKJAL_GUARDIAN 30 56}

        ##::northern drakes defend bottlenecks of the northern magma chamber
        # These locations were not make any sense. They were easy for dwaves to reach while
        # Drakes would struggle to get in.
        # After some testings, with just goal, target=protect unit radius = 20 was very suffice
        # Defenders moved around, grouped up, blocking here and there etc.
        # bottleneck_defense was unnecessary because drakes had no healer or leadership in this case
        # compared to grouping=defensive  +  goal target=protect unit radius = 20
        #[micro_ai]
        #	side=2
        #	ai_type=bottleneck_defense
        #	action=add

        #	x=12,16,19,37,38
        #	y=23,31,31,21,19
        #	enemy_x=11,16,20,38,38
        #	enemy_y=24,32,31,20,20

        #	active_side_leader=no
        #[/micro_ai]

        [unit]
            side=1
            {AH_CHARACTER_STATS:ULUTHUR}
            placement=leader
        [/unit]

        [unit]
            side=1
            {AH_CHARACTER_STATS:KHAZRAN}
            x,y=23,74
        [/unit]

        [recall]
            id=Malkrath
            x,y=27,72
        [/recall]

        ##:: give Khazran the burning heart too
        [object]
            silent=yes
            duration=forever
            [filter]
                id=Khazran
            [/filter]
            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_BURNING_HEART}
                [/abilities]
            [/effect]
        [/object]

        {RECALL_HIGHEST 25 75}
        {RECALL_HIGHEST 26 74}
        {RECALL_HIGHEST 27 74}
    [/event]

    ##:: event: start
    [event]
        name=start

        [fire_event]
            name=08_cutscene
        [/fire_event]
    [/event]

    ##:: scenario cutscene
    [event]
        name = 08_cutscene
        [delay]
            time=1500
        [/delay]

        {SCROLL_TO 25 52}

        [delay]
            time=2500
        [/delay]

        {SCROLL_TO 25 56}

        [message]
            speaker=Ilrandh
            message= _ "We have waited so long for this day. Now, all our pieces be finally in place. Dwarves, by the end of the day, the Oaken's stone shall be ours once more! The drakes shall fall before our might, and the Underearth Crown shall be complete! Fear not the fiery ones, for we have successfully weakened their inner flames. Our axes shall cut through them like paper, and our hammers will crush their skulls like twigs!"
        [/message]

        [message]
            speaker=Ilrandh
            message= _ "March on, my brethren! Shields high!"
        [/message]

        [delay]
            time=2500
        [/delay]

        {TREMOR}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Khazran
            message= _ "Your march ends here, dwarf!"
        [/message]

        [message]
            speaker=Ilrandh
            message= _ "The dragonheart has returned! Wha... what have you done to our runesmiths?"
        [/message]

        [message]
            speaker=Khazran
            message= _ "Their corpses feed the burning heart of our volcano."
        [/message]

        [message]
            speaker=Ilrandh
            message= _ "You monster... I see that it is come to this. I myself shall lead my troops! Skjal! Hold the rear flank - let no drake through!"
        [/message]

        {SCROLL_TO 25 54}

        [delay]
            time=1500
        [/delay]

        [message]
            speaker=Skjal
            message= _ "By the mountains, none shall pass!"
        [/message]

        {MOVE_UNIT (id=Skjal) 20 58}
        [heal_unit]
            [filter]
                id=Skjal
            [/filter]
            moves=full
            amount=0
            animate=yes
        [/heal_unit]
        [delay]
            time=1000
        [/delay]
        {MOVE_UNIT (id=Skjal) 24 56}

        {SCROLL_TO 25 54}

        [delay]
            time=500
        [/delay]

        {MOVE_UNIT (id=Ilrandh) 25 54}
        {TELEPORT_UNIT (id=Ilrandh) 25 51}
        {FLASH_WHITE ()}
        {MOVE_UNIT (id=Ilrandh) 25 48}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Ilrandh
            message= _ "Krindil! Elqadil! To my side!"
        [/message]

        [message]
            speaker=Krindil
            message= _ "Aye, sir!"
        [/message]

        [message]
            speaker=Elqadil
            image_pos = right
            message= _ "As ye will!"
            mirror = yes
        [/message]

        ##::Ilrandh calls his loyals to him -> soldiers near him switch, dragonguards come in
        {MOVE_UNIT (x,y=24,47) 19 48}
        {MOVE_UNIT (x,y=24,48) 19 49}

        {MOVE_UNIT (x,y=26,47) 31 48}
        {MOVE_UNIT (x,y=26,48) 31 49}

        {MOVE_UNIT (id=Krindil) 24 48}
        {MOVE_UNIT (id=Elqadil) 26 48}

        {MOVE_UNIT (id=Ilrandh) 25 47}
        {MOVE_UNIT (id=Krindil) 24 47}
        {MOVE_UNIT (id=Elqadil) 26 47}

        [message]
            speaker=Ilrandh
            message= _ "Corrondil! Percatdol!"
        [/message]

        {MOVE_UNIT (id=Corrondil) 24 48}
        {MOVE_UNIT (id=Percatdol) 26 48}

        [message]
            speaker=Corrondil
            message= _ "We be here to serve!"
        [/message]

        [message]
            speaker=Percatdol
            message= _ "At yer side!"
            image_pos = right
            mirror = yes
        [/message]

        [message]
            speaker=Ilrandh
            message= _ "Kerdin!"
        [/message]

        [delay]
            time=2000
        [/delay]

        [message]
            speaker=Ilrandh
            message= _ "Kerdin, where in the name of the mountains are you?!"
        [/message]

        [message]
            speaker=Kerdin
            message= _ "Aaayyyee!"
        [/message]

        {MOVE_UNIT (id=Kerdin) 25 48}

        ##::some more dwarves moves, riders appear
        {MOVE_UNIT (x,y=23,48) 20 48}
        {MOVE_UNIT (x,y=23,49) 20 49}

        {MOVE_UNIT (x,y=27,48) 30 48}
        {MOVE_UNIT (x,y=27,49) 30 49}

        {MOVE_UNIT (x,y=22,47) 20 46}
        {MOVE_UNIT (x,y=22,48) 19 51}

        {MOVE_UNIT (x,y=28,47) 30 46}
        {MOVE_UNIT (x,y=28,48) 31 51}

        {MOVE_UNIT (id=Cent1) 23 48}
        {MOVE_UNIT (id=Cent2) 27 48}

        {SCROLL_TO 25 47}

        [message]
            speaker=Ilrandh
            message= _ "By the day's eve, we shall storm their fortress and reforge the Underearth Crown! Then..."
        [/message]

        [animate_unit]
            [filter]
                id=Ilrandh
            [/filter]
            flag=victory
        [/animate_unit]

        [message]
            speaker=Ilrandh
            message= _ "... the runes shall release their true power and the mountains' throne shall be ours!"
        [/message]

        [animate_unit]
            [filter]
                id=Ilrandh
            [/filter]
            flag=victory
        [/animate_unit]

        [message]
            speaker=Ilrandh
            message= _ "Axes up!"
        [/message]

        [message]
            speaker=Herkarth
            message= _ "The dwarves seek the treasure we claimed from them?"
        [/message]

        [message]
            speaker=Khazran
            message= _ "The Oaken's Stone contains great power, Herkarth. It is the last piece of the Underearth Crown, a legendary artifact possessed of untold power. If the stoneheads manage to wrest the Oaken's Stone from us... the Underearth Crown will be unleashed and the dwarves will surely eradicate us all. We must stop Ilrandh from reaching the Stone."
        [/message]

        [message]
            speaker=Herkarth
            message= _ "Then our situation is most dire. King Menor IV stands alone at the Ashen's Maw, but the dwarves block our path to him. We will not reach him before they do!"
        [/message]

        [message]
            speaker=Uluthur
            message= _ "My wings are faster than the wind. I shall go."
        [/message]

        [message]
            speaker=Khazran
            message= _ "Go quickly! Once you reach the king, I can focus the power of my fire upon you to teleport to him as well. Wind carry you!"
        [/message]

        # move player leader units to their keeps
        {MOVE_UNIT (id="Herkarth") 21 68}
        {MOVE_UNIT (id="Khazran") 32 69}

        [fire_event]
            name=08_start_battle
        [/fire_event]
    [/event]

    ##:: scenario: setup battle
    [event]
        name = 08_start_battle
        ##:: Objectives
        [objectives]
            side=1
            [objective]
                description= _ "Move Uluthur to Menor IV"
                condition=win
            [/objective]
            [objective]
                description= _ "Defeat Ilrandh"
                condition=win
            [/objective]
            [objective]
                description= _ "Ilrandh reaches the Oaken's Stone"
                condition=lose
            [/objective]
            [objective]
                description= _ "Herkarth dies"
                condition=lose
            [/objective]
            [objective]
                description= _ "Khazran, the Dragonheart, dies"
                condition=lose
            [/objective]
            [objective]
                description= _ "Uluthur dies"
                condition=lose
            [/objective]
            [objective]
                description= _ "Menor IV dies"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
            [note]
                description= _ "Khazran is able to recruit and recall units."
            [/note]
            [note]
                description= _ "Khazran can teleport between owned villages."
            [/note]
        [/objectives]
    [/event]

    ##:: give notification about the wind runes
    [event]
        name=enter_hex
        first_time_only=yes

        [filter]
            side=1
            x=27,30,37,27
            y=70,67,71,64
        [/filter]

        [message]
            speaker=Khazran
            message= _ "I know these runes. They are called wind runes and are used by the dwarves to quickly traverse underground paths."
        [/message]

        # flash the nearby runes to let player know
        {AH_FLASH_TILE 27 70 (misc/green-flash-border.png) (scenery/rune2-glow.png)}
        {AH_FLASH_TILE 30 67 (misc/green-flash-border.png) (scenery/rune2-glow.png)}
        {AH_FLASH_TILE 37 71 (misc/green-flash-border.png) (scenery/rune2-glow.png)}
        {AH_FLASH_TILE 27 64 (misc/green-flash-border.png) (scenery/rune2-glow.png)}
    [/event]

    ##:: event: Khazran attacks (ranged) and hits someone
    [event]
        name="attacker_hits"
        first_time_only=yes

        [filter]
            id="Khazran"
        [/filter]
        [filter_attack]
            range=ranged
        [/filter_attack]

        [message]
            speaker="Khazran"
            message=_"<i>(roars)</i> Taste the intense flames of the ancestors!"
        [/message]
    [/event]

    ##:: event: Khazran attacks (melee) and hits someone
    [event]
        name="attacker_hits"
        first_time_only=yes

        [filter]
            id="Khazran"
        [/filter]
        [filter_attack]
            range=melee
        [/filter_attack]

        [message]
            speaker="Khazran"
            message=_"<i>(roars)</i> I am going to tear you apart, inch by inch!"
        [/message]
    [/event]

    ##:: event: teleport A to B
    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y=25,51
        [/filter]
        {SCROLL_TO 25 54}
        {FLASH_WHITE ()}
        {TELEPORT_UNIT (x,y=$x1,$y1) 25 54}
    [/event]

    ##:: event: teleport B to A
    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y=25,54
        [/filter]
        {SCROLL_TO 25 51}
        {FLASH_WHITE ()}
        {TELEPORT_UNIT (x,y=$x1,$y1) 25 51}
    [/event]

    ##:: Uluthur reaches nearby Menor IV
    [event]
        name=moveto
        first_time_only=yes

        [filter]
            id=Uluthur
            x,y=11-37,7-28
        [/filter]
        {SCROLL_TO $x1 $y1}
        [delay]
            time=1500
        [/delay]

        [message]
            speaker=Uluthur
            message= _ "Khazran! Let the fires of the Menor burn again!"
        [/message]

        [teleport]
            [filter]
                id=Khazran
            [/filter]
            x,y=$x1,$y1
            animate=yes
        [/teleport]

        [delay]
            time=1500
        [/delay]

        [message]
            speaker=Menor IV
            message= _ "By the Ashen's Maw! Is... is that you, Khazran?"
        [/message]

        [message]
            speaker=Khazran
            message= _ "It is. Your bloodline shares my flame, Menor IV, but without our connection, the fire of kings has dwindled over time. The ashes devour you from within."
        [/message]

        [message]
            speaker=Menor IV
            message= _ "Then enlighten me with your flame, dragonheart! Restore our strength, and we shall show the dwarves the folly of their insolence. Those who have the audacity to assault the Ashen's Maw itself shall perish in its burning core!"
        [/message]

        [store_unit]
            [filter]
                id=Menor IV
            [/filter]
            variable=menor
        [/store_unit]

        {MOVE_UNIT (id=Khazran) $menor.x $menor.y}

        {SCROLL_TO $menor.x $menor.y}

        [message]
            speaker=Khazran
            message= _ "Then open yourself to me, king of the Menor! Open your heart and embrace the fire!"
        [/message]

        [animate_unit]
            flag=attack
            [filter]
                id=Khazran
            [/filter]
            hits=yes

            [primary_attack]
                range=ranged
            [/primary_attack]

            [facing]
                x,y=$menor.x,$menor.y
            [/facing]
        [/animate_unit]

        [modify_unit]
            [filter]
                side=2
            [/filter]
            [object]
                silent=yes
                duration=forever
                [effect]
                    apply_to=halo
                    halo=halo/burningheart-[1~5].png~O(40%):160
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_BURNING_HEART}
                    [/abilities]
                [/effect]
            [/object]
        [/modify_unit]

        [message]
            speaker=Menor IV
            message= _ "The heat... I can feel its strength! The flame of our ancestors burns within me once more!"
        [/message]

        [repeat]
            times=2
            [do]
                [animate_unit]
                    flag=attack
                    [filter]
                        id=Menor IV
                    [/filter]
                    hits=yes

                    [primary_attack]
                        range=ranged
                    [/primary_attack]

                    [facing]##somewhere to the south of Menor
                        x,y=25,30
                    [/facing]
                [/animate_unit]
            [/do]
        [/repeat]

        [delay]
            time=1500
        [/delay]

        [message]
            speaker=Menor IV
            message= _ "It is stronger than ever! The ashen fire is gone, and in its place, the fire of the Menor burn proudly again!"
        [/message]

        [message]
            speaker=Khazran
            message= _ "Your strength has returned, Menor IV. Now, the dwarves will know the true power of the drakes!"
        [/message]

        [message]
            speaker=Menor IV
            message= _ "Yes, let the fire consume all to ashes! Herkarth, prepare to attack!"
        [/message]

        # To make this easier in HARD, give gold to Menor. This prolonged Menor's life by 6+ turns

        [gold]
            side=2
            amount={ON_DIFFICULTY 100 120 150}
        [/gold]

        ##:: Objectives
        [objectives]
            side=1
            [objective]
                description= _ "Defeat Ilrandh"
                condition=win
            [/objective]
            [objective]
                description= _ "Ilrandh reaches the Oaken's Stone"
                condition=lose
            [/objective]
            [objective]
                description= _ "Herkarth dies"
                condition=lose
            [/objective]
            [objective]
                description= _ "Khazran, the Dragonheart, dies"
                condition=lose
            [/objective]
            [objective]
                description= _ "Uluthur dies"
                condition=lose
            [/objective]
            [objective]
                description= _ "Menor IV dies"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
            [note]
                description=_"Khazran can recruit and recall."
            [/note]
            [note]
                description=_"Khazran can teleport between owned villages."
            [/note]
        [/objectives]

        # give side 2 burning heart for recruit
        [event]
            name=recruit
            first_time_only=no
            [filter_second]
                id=Menor IV
            [/filter_second]

            [modify_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=halo
                        halo=halo/burningheart-[1~5].png~O(40%):160
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_BURNING_HEART}
                        [/abilities]
                    [/effect]
                [/object]
            [/modify_unit]
        [/event]
    [/event]

    ##:: heal Ilrandh if any unit other than Khazran attacks him
    [event]
        name=attacker_hits
        first_time_only=no

        [filter]
            [not]
                id=Khazran
            [/not]
        [/filter]

        [filter_second]
            id=Ilrandh
        [/filter_second]

        [fire_event]
            name="non_Khazran_attacks_Ilrandh"
        [/fire_event]

        [heal_unit]
            [filter]
                id=Ilrandh
            [/filter]
            animate=yes
            amount=$damage_inflicted
        [/heal_unit]
    [/event]

    ##:: handle edge case of Khazran attacking Ilrandh with his melee
    # which is not a magical type attack
    # that can kill him
    [event]
        name=attacker_hits
        first_time_only=no

        [filter]
            id=Khazran
        [/filter]
        [filter_attack]
            range=melee
            type=blade
        [/filter_attack]

        [filter_second]
            id=Ilrandh
        [/filter_second]

        [fire_event]
            name="Khazran_melee_attacks_Ilrandh"
        [/fire_event]

        [heal_unit]
            [filter]
                id=Ilrandh
            [/filter]
            animate=yes
            amount=$damage_inflicted
        [/heal_unit]
    [/event]

    ##:: mention that only Khazran's fire can destroy Ilrandh
    [event]
        name=attacker_hits
        first_time_only=yes

        [filter]
            id=Khazran
        [/filter]
        [filter_attack]
            range=ranged
            type=fire
        [/filter_attack]

        [filter_second]
            id=Ilrandh
        [/filter_second]

        [message]
            speaker=Ilrandh
            message= _ "What? I am not being protected?! What is this?"
        [/message]

        [message]
            speaker=Khazran
            message= _ "You may have augmented yourself to be immune to most weapons. However, the intense fire that burns within me is potent enough to superceed what paltry magic you have, dwarf!"
        [/message]

        [message]
            speaker=Khazran
            message= _ "Prepare to meet your end, dwarf!"
        [/message]
    [/event]

    ##:: event: Khazran attacks Ilrandh in melee
    [event]
        id="Khazran_melee_attacks_Ilrandh"
        name="Khazran_melee_attacks_Ilrandh"
        first_time_only=yes

        [message]
            speaker=Khazran
            message= _ "No, no! I have to use my fire to bring him down! My claws will not do any damage to him!"
        [/message]
    [/event]

    ##:: event: if any unit other than Khazran attacks Ilrandh
    # we give a one-time only dialogue
    [event]
        id="non_Khazran_attacks_Ilrandh"
        name="non_Khazran_attacks_Ilrandh"
        first_time_only=yes

        [message]
            speaker=Khazran
            message= _ "No, no! His crown is protecting him from your flames. But my fire burns with greater intensity. I shall bring him down!"
        [/message]
    [/event]

    ##:: If Herkarth recruits a fresh unit, the buff of Khazran is applied to him
    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=1
        [/filter]

        [modify_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [object]
                silent=yes
                duration=forever
                [effect]
                    apply_to=halo
                    halo=halo/burningheart-[1~5].png~O(40%):160
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_BURNING_HEART}
                    [/abilities]
                [/effect]
            [/object]
        [/modify_unit]
    [/event]

    # Most of time, Menor would die first
    [event]
        name=moveto
        [filter]
            id=Ilrandh
            x=26,26,25,24,24,25
            y=14,13,13,13,14,15
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    ##:: event: Skjal has been killed
    [event]
        name="last breath"

        [filter]
            id=Skjal
        [/filter]

        [message]
            speaker="Skjal"
            message=_"Forgive me, me king! I have failed ye!"
        [/message]

        [message]
            speaker="Ilrandh"
            message=_"Do not grief, loyal Skjal. I shall claim the Oaken's Stone and bring forth the reign of the dwarves!"
        [/message]
    [/event]

    ##:: event: Ilrandh is defeated
    [event]
        name=last_breath
        [filter]
            id=Ilrandh
        [/filter]

        [message]
            speaker=Ilrandh
            message= _ "The... the... Oaken's Stone... give it... to me."
        [/message]

        [message]
            speaker=Khazran
            message= _ "Your time has come, dwarf. Embrace your end."
        [/message]

        [message]
            speaker=Ilrandh
            message= _ "Aaaarrrgggghhhh!"
        [/message]

        [hide_unit]
            id=Ilrandh
        [/hide_unit]

        [item]
            x,y=$x1,$y1
            image=items/underearth_crown.png
            halo=halo/magical-shield-[1~6].png:150
        [/item]

        [delay]
            time=2500
        [/delay]

        {MOVE_UNIT (id=Khazran) $x1 $y1}

        [message]
            speaker=Khazran
            message= _ "No dwarf shall ever again take the Underearth Crown. Its power presents too great a risk to us. It must be destroyed"
        [/message]

        [animate_unit]
            flag=attack
            [filter]
                id=Khazran
            [/filter]
            hits=yes

            [primary_attack]
                range=ranged
            [/primary_attack]

            [facing]
                x,y=$x1,$y1
            [/facing]
        [/animate_unit]

        {FLASH_WHITE ()}

        [delay]
            time=1000
        [/delay]

        {FLASH_WHITE ()}

        [delay]
            time=1000
        [/delay]

        {FLASH_WHITE ()}

        [delay]
            time=500
        [/delay]

        {FLASH_WHITE ()}

        [delay]
            time=500
        [/delay]

        {FADE_STEP 32 5}
        {FADE_STEP 64 5}
        {FADE_STEP 96 5}
        {FADE_STEP 128 5}
        {FADE_STEP 160 5}
        {FADE_STEP 192 5}
        {FADE_STEP 224 5}
        {FADE_STEP 256 5}
        {FADE_STEP 512 5}

        [kill]
            side=3,4,5
            animate=yes
        [/kill]

        [remove_item]
            x,y=$x1,$y1
            image=items/underearth_crown.png
            halo=halo/magical-shield-[1~6].png:150
        [/remove_item]

        {FADE_STEP 256 5}
        {FADE_STEP 224 5}
        {FADE_STEP 192 5}
        {FADE_STEP 160 5}
        {FADE_STEP 128 5}
        {FADE_STEP 96 5}
        {FADE_STEP 64 5}
        {FADE_STEP 32 5}
        {FADE_STEP 0 5}

        [message]
            speaker=Herkarth
            message= _ "It is done. The Underearth Crown is no more. The dwarvish king is fallen. The stoneheads' army is burned to ashes."
        [/message]

        [message]
            speaker=Khazran
            message= _ "And the hearts of the Menor burn a flame with the blood of the dragons again. Never again shall anyone dare to sever the connection of our fire."
        [/message]

        [message]
            speaker=Menor IV
            message= _ "Indeed. Herkarth, I thank you. You've freed Khazran and reforged our link with the dragons. Our victory today is owed to you."
        [/message]

        [message]
            speaker=Uluthur
            message= _ "That's not all. We have braved the biting frost and ice, crawled through the darkest depths of the underground, faced the mightiest runes of the dwarves, and restored the lifeblood of our kind. Herkarth is a hero!"
        [/message]

        [message]
            speaker=Menor IV
            message= _ "Forsooth, he is. And so I say this. Even though our tradition demands the crown of the drakes be won in battle, or granted after my passing, we shall rewrite our customs today in recognition of Herkarth's service. The succession of the kings shall no longer be a matter of death and blood, no, it shall be a matter of deeds."
        [/message]

        [message]
            speaker=Menor IV
            message= _ "In this matter, Herkarth, you have honourably led the drakes far better than I have ever done. You have saved our people and our home, and restored the strength of our inner flame. And therefore, you shall be our new king. Come to me."
        [/message]

        [store_unit]
            [filter]
                id=Menor IV
            [/filter]
            variable=menor
        [/store_unit]

        {MOVE_UNIT (id=Herkarth) $menor.x $menor.y}
        {MOVE_UNIT (id=Khazran) $menor.x $menor.y}
        {MOVE_UNIT (id=Uluthur) $menor.x $menor.y}

        [message]
            speaker=Menor IV
            message= _ "In the name of the Ashen's Maw, in the name of the mighty Menor, shall I, King Menor IV, lay down the crown, for a new Menor with the virtues of a king has revealed himself. I crown you, Herkarth, to be <i>King Menor V, the Fire of Menor, the First of the Ashen's Maw, the Ruler of Drakes</i>. Our King."
        [/message]

        [object]
            name="Crown of the Menor"
            image=icons/circlet_winged.png
            description=_ "This unit has been crowned King"

            duration=forever
            silent=no
            [filter]
                id=Herkarth
            [/filter]
        [/object]

        # change Herkarth's name to Menor the V
        {MODIFY_UNIT (id="Herkarth") name (_"Menor V")}

        [message]
            speaker=Menor IV
            message= _ "Lead us wisely, King Menor V."
        [/message]

        [message]
            speaker=Herkarth
            message= _ "Thank you. I will not let you down, Menor IV. Under my rule, the drakes of the Ashen's Maw shall make our strength known across all of Irdya. And no race - man, dwarf, elf or drake - shall ever again dare to threaten the Maw, for the fire of the drakes once again defends our home proudly."
        [/message]

        [message]
            speaker=Uluthur
            message= _ "Uuuuhhh, <i>King Menor V, fire of Menor, first of the Ashen's Maw, rule of drakes</i>... that's quite a long name to remember. Perhaps I will still just call you <i>Herkarth</i>. As a friend would."
        [/message]

        [message]
            speaker=Herkarth
            message= _ "That's fine, Uluthur, my friend. You stood at my side during times of danger and your valorous heart has never wavered in your loyalty. If you wish it, I shall..."
        [/message]

        [message]
            speaker=Uluthur
            message= _ "No, setting me at your side in the Ashen's Maw would not be fitting. As with the other drakes of the sky, this volcano is no place for me, for we must be as free as the winds. And so I will continue riding the winds and bring you news from afar - I will explore the world far and wide and serve in your name, Menor V!"
        [/message]

        [message]
            speaker=Herkarth
            message= _ "As you will, my friend. And so, a new era of drakes is upon us."
        [/message]

        # add achievement
        {ASHEN_HEARTS_ACHIEVEMENT_SCENARIO 08_Ilrandh}

        [endlevel]
            result=victory
            carryover_report=no
            linger_mode=no
        [/endlevel]
    [/event]

    ##:: event: Ilrandh spawns a runic mine
    # every 3 turns
    [event]
        name="side_3_turn"
        first_time_only=no

        [filter_condition]
            [lua]
                code=<< return wesnoth.current.turn % 4 == 0 >>
            [/lua]
        [/filter_condition]

        [store_unit]
            [filter]
                id=Ilrandh
            [/filter]
            kill=no
            variable=S8_rune_coords_temp
        [/store_unit]

        {PLACE_RUNIC_MINE $S8_rune_coords_temp.x $S8_rune_coords_temp.y}
        # {DEBUG_MSG (_"Runic Mine spawned at ($S8_rune_coords_temp.x, $S8_rune_coords_temp.y)")}

        {CLEAR_VARIABLE S8_rune_coords_temp}
    [/event]

    ##:: Malkrath is defeated
    [event]
        name="last breath"
        
        [filter]
            id=Malkrath
        [/filter]

        [message]
            speaker="Malkrath"
            message=_"I may fall, but my brethen fight on! Stop that stonehead scum!"
        [/message]
    [/event]

    ##:: Krindil has been defeated
    [event]
        name="last breath"

        [filter]
            id=Krindil
        [/filter]

        [message]
            speaker="Krindil"
            message=_"Me king... I have failed ye..."
        [/message]
    [/event]

    ##:: Elqadil has been defeated
    [event]
        name="last breath"

        [filter]
            id=Elqadil
        [/filter]

        [message]
            speaker="Elqadil"
            message=_"Agh... forgive me, Yer Majesty. I hae failed ye."
        [/message]
    [/event]

    ##:: Corrondil has been defeated
    [event]
        name="last breath"

        [filter]
            id=Corrondil
        [/filter]

        [message]
            speaker="Corrondil"
            message=_"I... I could not... forgive me, me king."
        [/message]
    [/event]

    ##:: Percatdol has been defeated
    [event]
        name="last breath"

        [filter]
            id=Percatdol
        [/filter]

        [message]
            speaker="Percatdol"
            message=_"By my beard... I have let ye down, me king."
        [/message]
    [/event]

    ##:: Kerdin has been defeated
    [event]
        name="last breath"

        [filter]
            id=Kerdin
        [/filter]

        [message]
            speaker="Kerdin"
            message=_"If only... forgive me, me king. I tried.."
        [/message]
    [/event]

    ##:: Crowndil has been defeated
    [event]
        name="last breath"

        [filter]
            id=Cent1
        [/filter]

        [message]
            speaker="Crowndil"
            message=_"Me king... I hae not been worthy."
        [/message]
    [/event]

    ##:: Heirdil has been defeated
    [event]
        name="last breath"

        [filter]
            id=Cent2
        [/filter]

        [message]
            speaker="Heirdil"
            message=_"This shame... I die with it. Forgive me, me king!"
        [/message]
    [/event]

    {AH_DEATHS:HERKARTH}
    {AH_DEATHS:KHAZRAN}
    {AH_DEATHS:MENOR}
    {AH_DEATHS:ULUTHUR}

    
[/scenario]
