#textdomain wesnoth-ah

[scenario]
    id=05_Runic_Gate
    name= _ "Runic Gate"
    next_scenario=06_Tears_of_the_Heartfangs
    # Insert the content of the file pointed to at this position.
    map_file=05_Runic_Gate.map
    snapshot=no
    {ASHEN_HEARTS_XP_MODIFIER}

    # load the macros at top level
    {./scenario-utils/05_Runic_Gate-utils.cfg}

    {SCENARIO_MUSIC knolls.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}
    {EXTRA_SCENARIO_MUSIC weight_of_revenge.ogg}

    ##::Story
    {AH_STORY_RUNIC_GATE}

    # Number of turns
    # {TURNS 46 42 40}
    {TURNS 60 56 52}

    # The player wins if all enemy leaders are dead.
    victory_when_enemies_defeated=no

    ##|| Flow Of Time ||##
    {DEFAULT_SCHEDULE}

    ##|| Determine Side Conditions ||##
    ##|| Player Side
    [side]
        {HERKARTH_SIDE}

        shroud=yes

        ##:: Gold and Income
        {GOLD 320 300 280}
        {INCOME 0 0 0}
    [/side]

    ##|| Dwarves
    [side]
        ##:: Side Info
        side=2
        controller=ai
        {TEAM_NAME:DWARVES}

        ##:: Leader Info
        type=Dwarvish Runemaster
        id=Kulkruldin
        name=_"Kulkruldin"
        facing=sw
        canrecruit=yes
        unrenamable=yes

        hidden=yes
        ##:: Recruit List
        recruit={ON_DIFFICULTY 
                (Dwarvish Fighter, Dwarvish Runesmith, Dwarvish Thunderer, Dwarvish Thunderguard) 
                (Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Runesmith, Dwarvish Thunderer, Dwarvish Thunderguard) 
                (Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Runesmith, Dwarvish Thunderer, Dwarvish Thunderguard)}

        [ai]
            aggression=0.66
            caution=0.33
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=20
            [/goal]
            # Lighting rune locations
            [avoid]
                x=31,31,30,37
                y=2,3,21,23
            [/avoid]
        [/ai]

        ##:: Gold and Income
        {GOLD 20 30 40}
        {INCOME 0 1 2}
    [/side]

    ##|| Dwarves
    [side]
        ##:: Side Info
        side=3
        controller=ai
        {TEAM_NAME:DWARVES}

        ##:: Leader Info
        type=Dwarvish Lord
        id=Krokkendol
        name=_"Krokkendol"
        facing=se
        canrecruit=yes
        unrenamable=yes

        ##:: Recruit List
        recruit={ON_DIFFICULTY 
                (Dwarvish Fighter, Dwarvish Runesmith, Dwarvish Thunderer, Dwarvish Thunderguard) 
                (Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Runesmith, Dwarvish Thunderer, Dwarvish Thunderguard) 
                (Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Runesmith, Dwarvish Thunderer, Dwarvish Thunderguard)}

        [ai]
            aggression=0.66
            caution=0.33

            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=20
            [/goal]
        [/ai]

        ##:: Gold and Income
        {GOLD 20 30 40}
        {INCOME 0 1 2}
    [/side]

    ##|| Elves
    [side]
        ##:: Side Info
        side=4
        controller=ai
        {TEAM_NAME:ELVES}

        ##:: Leader Info
        type=Elvish Sharpshooter
        id=Ilaindil
        name=_"Ilaindil"
        canrecruit=yes
        unrenamable=yes
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_INTELLIGENT}
        [/modifications]

        ##:: Recruit List
        recruit={ON_DIFFICULTY 
                (Elvish Ranger, Elvish Archer, Elvish Fighter, Wose) 
                (Elvish Ranger, Elvish Archer, Elvish Fighter, Elder Wose) 
                (Elvish Ranger, Elvish Archer, Elvish Fighter, Elder Wose)}

        [ai]
            [avoid]
                terrain=Uu^*,Uh^*
            [/avoid]
            aggression=0.70

            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=20
            [/goal]
        [/ai]
        ##:: Gold and Income
        {GOLD 100 120 140}
        {INCOME  0  1  2}
    [/side]
    
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 ("Elvish Fighter") ({ON_DIFFICULTY 2 3 3})}

    ##|| Merfolk
    [side]
        ##:: Side Info
        side=5
        controller=ai
        {TEAM_NAME:MERFOLK}

        ##:: Leader Info
        type=Mermaid Siren
        id=Elysia
        name=_"Elysia"
        canrecruit=yes
        unrenamable=yes

        ##:: Recruit List
        recruit={ON_DIFFICULTY 
                (Merman Hunter, Merman Spearman, Merman Fighter, Merman Warrior) 
                (Merman Netcaster, Merman Spearman, Merman Fighter, Merman Warrior) 
                (Merman Netcaster, Merman Spearman, Merman Fighter, Merman Warrior)}

        ##:: Gold and Income
        {GOLD 100 120 140}
        {INCOME 0 1 2}
        [ai]
            aggression=0.70
            caution=0.30
            [avoid]
                [not]
                    terrain=W*
                [/not]
                [and]
                    [not]
                        terrain=*^Vm
                    [/not]
                [/and]
            [/avoid]
        [/ai]
    [/side]

    ##|| Monsters
    [side]
        ##:: Side Info
        side=6
        controller=ai
        team_name=monsters
        user_team_name=_"Monsters"
        {FLAG_VARIANT6 ragged}

        ##:: Leader Info
        no_leader=yes
        hidden=yes

        ##:: Recruit List
        recruit=
        # add an avoid condition
        # to make them steer clear of the land
        # where they have poor defence
        [ai]
            [avoid]
                [not]
                    terrain=W*
                [/not]
                [and]
                    [not]
                        terrain=*^Vm
                    [/not]
                [/and]
            [/avoid]
        [/ai]
    [/side]

    ##:: Starting Villages
    {STARTING_VILLAGES 4 7}
    {STARTING_VILLAGES 5 5}

    ##:: prestart
    [event]
        name=prestart

        {ASHEN_HEART_RECALL_COSTS_ADJUSTMENT}

        ##:: Capture the nearby villages
        {CAPTURE_VILLAGES 3 31 8 15}

        {PLACE_IMAGE scenery/dwarven-doors-closed.png 39 6}

        {LOYAL_UNIT 2 (Dwarvish Protector) 31 21}
        {LOYAL_UNIT 2 (Dwarvish Protector) 37 22}

        {LOYAL_UNIT 2 (Dwarvish Runesmith) 31 20}
        {LOYAL_UNIT 2 (Dwarvish Runesmith) 36 21}

        {LOYAL_UNIT 2 (Dwarvish Protector) 32 2}
        {LOYAL_UNIT 2 (Dwarvish Protector) 32 3}
        {LOYAL_UNIT 2 (Dwarvish Runemaster) 33 3}

        {LOYAL_UNIT 4 (Elvish Ranger) 34 35}
        {LOYAL_UNIT 4 (Elvish Ranger) 36 34}

        {LOYAL_UNIT 5 (Mermaid Priestess) 9 10}
        {LOYAL_UNIT 5 (Merman Spearman) 9 9}

        {GENERIC_UNIT 2 (Dwarvish Protector) 22 14}
        {GENERIC_UNIT 2 (Dwarvish Protector) 21 14}
        {GENERIC_UNIT 2 (Dwarvish Protector) 24 15}
        {GENERIC_UNIT 2 (Dwarvish Protector) 25 16}

        {GENERIC_UNIT 2 (Dwarvish Runesmith) 22 13}
        {GENERIC_UNIT 2 (Dwarvish Protector) 23 14}
        {GENERIC_UNIT 2 (Dwarvish Protector) 25 15}
        {GENERIC_UNIT 2 (Dwarvish Runesmith) 26 15}

        {GENERIC_UNIT 2 (Dwarvish Thunderguard) 24 13}
        {GENERIC_UNIT 2 (Dwarvish Thunderguard) 23 13}
        {GENERIC_UNIT 2 (Dwarvish Thunderguard) 26 14}
        {GENERIC_UNIT 2 (Dwarvish Thunderguard) 27 15}

        {LOYAL_UNIT 2 (Bear Cavalry) 27 13}

        # Units at gates
        [modify_unit]
            [filter]
                x=21-27
                y=10-16
                side=2
            [/filter]
            [status]
                guardian=yes
            [/status]
            facing=sw
        [/modify_unit]

        # units placed near the entrance of the temple
        # as it's an easy win without them
        {LOYAL_UNIT 2 ("Dwarvish Dragonguard") 39  4}{GUARDIAN}
        {LOYAL_UNIT 2 ("Dwarvish Runemaster") 38  7}{GUARDIAN}
        {LOYAL_UNIT 2 ("Dwarvish Runemaster") 40  6}{GUARDIAN}
        {LOYAL_UNIT 2 ("Dwarvish Sentinel") 38  5}{GUARDIAN}
        {LOYAL_UNIT 2 ("Dwarvish Sentinel") 40  5}{GUARDIAN}
        {LOYAL_UNIT 2 ("Dwarvish Sentinel") 37  6}{GUARDIAN}
        {LOYAL_UNIT 2 ("Dwarvish Sentinel") 41  6}{GUARDIAN}

        {PLACE_RUNIC_MINE 30 21}
        {PLACE_RUNIC_MINE 37 23}

        {PLACE_RUNIC_MINE 31 2}
        {PLACE_RUNIC_MINE 31 3}

        [time_area]
            x=13-46,26-46
            y=0-17,18-28
            {UNDERGROUND}
        [/time_area]

        ##::dwarvish guardians defend bottlenecks

        # Defense north entrance
        [micro_ai]
            side=2
            ai_type=bottleneck_defense
            action=add
            ca_score=100000
            [filter]
                x=32,32,33
                y=2,3,3
            [/filter]
            x=32,32
            y=2,3
            enemy_x=31,31
            enemy_y=2,3
        [/micro_ai]

        # Defense south entrance
        [micro_ai]
            side=2
            ai_type=bottleneck_defense
            action=add
            ca_score=100000
            [filter]
                x=31,31
                y=21,20
            [/filter]
            x=31
            y=21
            enemy_x=30
            enemy_y=21
        [/micro_ai]

        # Defense south east entrance
        [micro_ai]
            side=2
            ai_type=bottleneck_defense
            action=add
            ca_score=100000
            [filter]
                x=37,36
                y=22,21
            [/filter]
            x=37
            y=22
            enemy_x=37
            enemy_y=23
        [/micro_ai]

        # Disabled this micro ai. It seemed to overwrite the previous one causing lag
        #[micro_ai]
        #    side=2
        #    ai_type=goto
        #    action=add
        #		ca_score=120000

        #    [filter]
        #        type=Dwarvish Protector, Dwarvish Runesmith, Dwarvish Runemaster
        #    [/filter]
        #    [filter_location]
        #        [filter]
        #        [/filter]
        #        [not]
        #            [filter]
        #                side=1
        #            [/filter]
        #            radius=0
        #        [/not]
        #    [/filter_location]
        #[/micro_ai]

        ##::Elvish Rangers and Woses
        [micro_ai]
            side=4
            ai_type=lurkers
            action=add

            [filter]
                type=Elvish Ranger, Elder Wose, Wose
            [/filter]
            [filter_location]
                terrain=*^F*
            [/filter_location]
            [filter_location_wander]
                terrain=*^F*
            [/filter_location_wander]
        [/micro_ai]

        [micro_ai]
            side=3
            ai_type=zone_guardian
            action=add
            ca_score=170000
            [filter]
                side=3
                [not]
                    id=Krokkendol
                [/not]
            [/filter]
            [filter_location]
                x=15-31,20-46,31-46
                y=2-11,12-16,17-22
                terrain=R*^*,U*^*,C*^*,K*^*
            [/filter_location]
        [/micro_ai]

        {GENERIC_UNIT 6 (Sea Serpent) 20 20}

        [micro_ai]
            side=6
            ai_type=return_guardian
            action=add

            [filter]
                type=Sea Serpent
            [/filter]
            return_x,return_y=20,20
        [/micro_ai]

        [set_variables]
            name=glyphs

            [value]
                x,y=10,9
                image_off=scenery/rune1.png
                image_on=scenery/rune1-glow.png
            [/value]
            [value]
                x,y=35,35
                image_off=scenery/rune2.png
                image_on=scenery/rune2-glow.png
            [/value]
        [/set_variables]

        [foreach]
            array=glyphs
            [do]
                [item]
                    x,y=$this_item.x,$this_item.y
                    image=$this_item.image_on
                [/item]
            [/do]
        [/foreach]

        [unit]
            side=1
            {AH_CHARACTER_STATS:ULUTHUR}
            placement=leader
        [/unit]

        # assign variables
        {VARIABLE AH_S5_dwarves_sighted "no"}
        {VARIABLE AH_S5_dwarven_leaders_killed "no"}
    [/event]

    ##:: start event
    [event]
        name=start

        [message]
            speaker=Herkarth
            # po: by "his Fire", I meant the 'Fire of Menor'. That is, of this present time, only Menor IV and Herkarth know of the location of this temple.
            message= _ "Here it is, the temple of our ancestors! The location of this temple is sacred. Only the reigning Menor and his Fire know of this location, as it has been passed from generation to generation. Our ancestors once defended this temple with pride and ferocity. However, it had to be abandoned as our forces withdrew due to persistent attacks from our enemies, especially, the stoneheads."
        [/message]

        [message]
            speaker=Herkarth
            message= _ "Many generations have passed since it had been sealed by the sorcery of our forefathers. The foul stoneheads must have forced their way into the temple and done something to sever the link between us and the dragons."
        [/message]

        [message]
            speaker=Uluthur
            message=_"I fear that may be the case. We must not delay, friend."
        [/message]

        [message]
            speaker=Herkarth
            message= _ "Onwards!"
        [/message]

        # move Herkarth to his keep
        {MOVE_UNIT (id="Herkarth") 3 32}

        ##:: activate the mini quest of elri
        [if]
            [have_unit]
                id=Elri
                search_recall_list=yes
            [/have_unit]
            [then]
                [recall]
                    id=Elri
                [/recall]

                [message]
                    speaker=Elri
                    message= _ "I sense the presence of the traitor. Help me find him, so that I may end his life."
                [/message]
            [/then]
        [/if]

        ##:: Objectives
        {AH_RUNIC_OBJECTIVE}
    [/event]

    ##:: sighted merfolk
    [event]
        name=sighted
        first_time_only=yes

        [filter]
            race=merman
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "In the name of Naia, the drakes are approaching! We must not let them enter the temple, lest they awaken the one inside! Hold them back!"
        [/message]

        [message]
            speaker="Herkarth"
            message=_"What is this? The merfolk are here, so far from their homes?"
        [/message]
        
        # this is a reference to WoF scenario 4
        # the one where you slaughtered all the merfolk
        [message]
            speaker="Uluthur"
            message=_"Centuries have passed and yet they still bear the grudges of their ancestors against us. They certainly wish for our destruction."
        [/message]

        [message]
            speaker="Herkarth"
            message=_"If they are against us, we have no choice but to force their withdrawal from here. Do not hold back."
        [/message]

        [message]
            type_adv_tree=Drake Burner,Drake Fighter,Drake Clasher
            canrecruit=no
            message=_"As you command, Fire of Menor!"
        [/message]
    [/event]

    ##:: sighted merfolk leader
    [event]
        name=sighted
        first_time_only=yes

        [filter]
            id=Elysia
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        {GENERIC_UNIT 5 ("Merman Spearman")  6  8}{GUARDIAN}
        {GENERIC_UNIT 5 ("Merman Hoplite")  10 12}{GUARDIAN}
        {GENERIC_UNIT 5 ("Merman Warrior") 10 10}{GUARDIAN}
    [/event]

    ##:: sighted elves
    [event]
        name=sighted
        first_time_only=yes

        [filter]
            race=elf
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "By Wesmere, the drakes have arrived! May the sylphs guide our arrows into the ashen hearts of these beasts! Slay them all!"
        [/message]

        [if]
            [have_unit]
                id=Elri
                search_recall_list=yes
            [/have_unit]
            [then]
                [message]
                    speaker=Elri
                    message= _ "These must be the traitor's followers."
                [/message]

                [message]
                    speaker=Herkarth
                    message= _ "They seek to attack and bar our path to the temple. And they are of your kind. Are you sure we can trust you, elf?"
                [/message]

                [message]
                    speaker=Elri
                    message= _ "Your temple is not of concern to us elves. I have already told you, my goal is to hunt a traitor who has violated our laws and disobeyed the orders of our elders. I seek to make him pay in blood, no less, no more. It is not my task, nor my place to interfere with the matter of your temple."
                [/message]

                [message]
                    speaker=Elri
                    message= _ "Ilaindil is the traitor's name. Let me find him and claim the debt of blood that he owes the Lintair elves. You may do whatever you must after."
                [/message]

                [message]
                    speaker="Uluthur"
                    message=_"Elves and dwarves...united against us? What events have transpired beyond our knowledge that have led them to put aside their centuries old hostilities?"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Herkarth
                    message= _ "The elves seek to attack and bar our path to the temple."
                [/message]

                [message]
                    speaker="Uluthur"
                    message=_"Elves and dwarves...united against us? What events have transpired beyond our knowledge that have led them to put aside their centuries old hostilities?"
                [/message]
            [/else]
        [/if]
    [/event]

    ##:: sighted dwarves
    [event]
        name=sighted
        first_time_only=yes

        [filter]
            race=dwarf
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "Kulkruldin, tha drakes be here! We need reinforcements! Dwarves, fortify tha walls! Shields high!"
        [/message]

        [message]
            speaker=Herkarth
            message= _ "Those pesky stoneheads have fortified the walls and the spear-wielding ones defend them with their shields. Perhaps our <b>enforcers and thrashers</b> can break through, or perhaps we can find another way around."
        [/message]

        {VARIABLE AH_S5_dwarves_sighted yes}

        [show_objectives]
        [/show_objectives]
    [/event]

    ##:: attacking a dwarf protector
    [event]
        name=attack
        first_time_only=yes

        [filter]
            side=1
        [/filter]
        [filter_second]
            type=Dwarvish Protector
        [/filter_second]

        [message]
            speaker=Herkarth
            message= _ "These stoneheads are very resilient. Their runic magic must be reinforcing their shields. We will need something with more impact to break through them."
        [/message]
    [/event]

    ##:: smashing the weak cave wall events
    # event: indicate to players that they can break walls
    # if they have any enforcer or thrasher 
    [event]
        name=enter_hex
        first_time_only=yes
        [filter]
            side=1
            x,y=8-13,6-11
        [/filter]

        [message]
            speaker=unit
            message= _ "Look there, those walls are less durable! Our thrashers or enforcers can probably break through them with their rams!"
        [/message]

        {AH_FLASH_TILE 14 7 misc/green-flash-border.png ()}
        {AH_FLASH_TILE 15 11 misc/green-flash-border.png ()}
    [/event]

    # event: wall break event
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=14,7
            type=Drake Thrasher, Drake Enforcer
        [/filter]

        [repeat]
            times=3
            [do]
                [animate_unit]
                    flag=attack
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    hits=yes

                    [primary_attack]
                        type=impact
                    [/primary_attack]

                    [facing]
                        x,y=15,7
                    [/facing]
                [/animate_unit]
            [/do]
        [/repeat]

        {EARTHQUAKE ()}
        [terrain]
            x,y=15,7
            terrain=Uh
        [/terrain]
        [redraw]
        [/redraw]

        [message]
            speaker=unit
            message=_"This was effortless! We can pre-emptively strike at the dwarves now!"
        [/message]
    [/event]

    # event: wall break event
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=15,11
            type=Drake Thrasher, Drake Enforcer
        [/filter]

        [repeat]
            times=3
            [do]
                [animate_unit]
                    flag=attack
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    hits=yes

                    [primary_attack]
                        type=impact
                    [/primary_attack]

                    [facing]
                        x,y=16,10
                    [/facing]
                [/animate_unit]
            [/do]
        [/repeat]

        {EARTHQUAKE ()}
        [terrain]
            x,y=16,10
            terrain=Uh
        [/terrain]
        [redraw]
        [/redraw]

        [message]
            speaker=unit
            message=_"The wall has been smashed to dust!"
        [/message]
    [/event]

    ##:: found the short cut to the temple entrance
    [event]
        name="enter_hex"
        first_time_only=yes

        [filter]
            side=1
            x=38,37,38
            y=10,11,11
        [/filter]

        [message]
            speaker=unit
            canrecruit=no
            message= _ "Look! The cave wall here is weak! Our thrashers or enforcers can probably break through them with their rams!"
        [/message]

        {AH_FLASH_TILE 38 10 misc/green-flash-border.png ()}

        # we indicate that the short cut is here
        [message]
            speaker="Herkarth"
            message=_"What an advantageous location! We can probably sneak in to the temple through here!"
        [/message]

        [message]
            speaker="Uluthur"
            message=_"An amazing find, indeed!"
        [/message]
    [/event]

    # event: wall break event
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=38,10
            type=Drake Thrasher, Drake Enforcer
        [/filter]

        [repeat]
            times=3
            [do]
                [animate_unit]
                    flag=attack
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    hits=yes

                    [primary_attack]
                        type=impact
                    [/primary_attack]

                    [facing]
                        x,y=39,10
                    [/facing]
                [/animate_unit]
            [/do]
        [/repeat]

        {EARTHQUAKE ()}
        [terrain]
            x,y=39,10
            terrain=Uh
        [/terrain]
        [redraw]
        [/redraw]

        [message]
            speaker=unit
            message=_"This seems to lead into a considerably sized chamber. I think the temple entrance is somewhere here!"
        [/message]
    [/event]

    ##:: event: Elri kills the traitor
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            id=Ilaindil
        [/filter]

        [filter_second]
            id=Elri
        [/filter_second]

        [message]
            speaker=Ilaindil
            message= _ "Ah... a bloodmaiden... they sent you... to find me?"
        [/message]

        [message]
            speaker=Elri
            message= _ "The elders did, Ilaindil. Your blood is demanded as payment for your crimes."
        [/message]

        [message]
            speaker=Ilaindil
            message= _ "What... have I done... to deserve this?"
        [/message]

        [message]
            speaker=Elri
            message= _ "You know what you have done, traitor to the elves of Lintanir. Your end shall be here."
        [/message]

        {ASHEN_HEARTS_ADD_SUB_ACHIEVEMENT Knyght_AH_elri_side_quest Knyght_AH_elri_revenge}

        {VARIABLE sword_x $x1}
        {VARIABLE sword_y $y1}
    [/event]

    ##:: event: Elri kills the traitor, and he dies
    [event]
        name=die
        first_time_only=yes
        [filter]
            id=Ilaindil
        [/filter]

        [filter_second]
            id=Elri
        [/filter_second]

        [message]
            speaker=Elri
            message= _ "I have completed my task and must return to Lintair forest to report my success to the elders. Our paths part here."
        [/message]

        [message]
            speaker=Herkarth
            message= _ "It was an honour to fight at your side."
        [/message]

        [message]
            speaker=Elri
            message= _ "Drakes, you aided me in my duty. As a token of appreciation, take my amulet."
        [/message]

        {AH_WISH_ITEM_AMULET_ELRI $sword_x $sword_y}

        [redraw]
        [/redraw]

        [message]
            speaker=Elri
            message= _ "Farewell."
        [/message]

        {MOVE_UNIT (id=Elri) 40 36}

        [kill]
            id=Elri
        [/kill]
        [show_objectives]
        [/show_objectives]
    [/event]

    ##:: event: the traitor is killed
    # but not by Elri
    [event]
        name=die
        first_time_only=yes
        [filter]
            id=Ilaindil
        [/filter]

        [filter_second]
            [not]
                id=Elri
            [/not]
        [/filter_second]

        [if]
            [have_unit]
                id=Elri
            [/have_unit]
            [then]
                [message]
                    speaker=Elri
                    message= _ "No! You killed him! The blood price placed on Ilaindil's head was for my blade, and my blade only. By taking my quarry from me, you have taken his mark upon yourselves. Now your blood will dye the rivers red!"
                [/message]

                [modify_unit]
                    [filter]
                        id=Elri
                    [/filter]
                    side=4
                [/modify_unit]

                {ASHEN_HEARTS_ADD_SUB_ACHIEVEMENT Knyght_AH_elri_side_quest Knyght_AH_elri_betrayal}
            [/then]
            [else]
                [message]
                    speaker=Ilaindil
                    message= _ "Ah... Slain by... Drakes... I should... not have... allied with the... dwarves..."
                [/message]

                [message]
                    speaker="Herkarth"
                    message= _ "The elves have been defeated. We should not delay any further and resume our advance towards the temple!"
                [/message]
            [/else]
        [/if]
        [show_objectives]
        [/show_objectives]
    [/event]

    ##:: elri is killed by drakes
    [event]
        name="last breath"
        
        [filter]
            id=Elri
        [/filter]
        [filter_second]
            side=1
            race=drake
        [/filter_second]

        [message]
            speaker="Herkarth"
            message=_"It grieves me to take the life of a former ally, but she left us little choice."
        [/message]
    [/event]

    ##:: elri is killed by other
    [event]
        name="last breath"
        
        [filter]
            id=Elri
        [/filter]
        [filter_second]
            [not]
                side=1
                race=drake
            [/not]
        [/filter_second]

        [message]
            speaker="Elri"
            message=_"Nooo! The blood price on my blade has not been quenched!"
        [/message]
    [/event]

    ##:: Herkarth moves to the entrance
    # and you defeated the dwarven leaders
    [event]
        name=moveto
        [filter]
            id=Herkarth
            x,y=39,6
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL AH_S5_dwarven_leaders_killed equals "yes"}
        [/filter_condition]

        [message]
            speaker=Herkarth
            message= _ "This is the entrance, let's go!"
        [/message]

        # elri leaves if her quest is incomplete
        [if]
            [have_unit]
                id=Elri
                search_recall_list=yes
            [/have_unit]
            [then]
                [recall]
                    id=Elri
                [/recall]

                [message]
                    speaker=Elri
                    message= _ "I can not join you. Ilaindil won't be inside the temple. I must seek him elsewhere."
                [/message]

                {MOVE_UNIT (id=Elri) 40 36}

                [kill]
                    id=Elri
                [/kill]

                [message]
                    speaker=Uluthur
                    message= _ "Hmmph."
                [/message]
            [/then]
        [/if]

        # add achievement
        {ASHEN_HEARTS_ACHIEVEMENT_SCENARIO 05_Runic_Gate}

        [endlevel]
            result=victory
            carryover_percentage=10
            carryover_add=yes
        [/endlevel]
    [/event]

    ##:: Herkarth moves to the entrance
    # but the dwarven leaders still live
    [event]
        name=moveto
        [filter]
            id=Herkarth
            x,y=39,6
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL AH_S5_dwarven_leaders_killed equals "no"}
        [/filter_condition]

        [message]
            speaker=Herkarth
            message= _ "Here, is the entrance. I fear leaving the dwarves unscatched here while we descend into the temple, is not the smartest of moves."
        [/message]

        [message]
            speaker=Uluthur
            message=_"What do you suggest, Herkarth?"
        [/message]

        [message]
            speaker=Herkarth
            message=_"We defeat them here so that they do not attack us from the rear."
        [/message]

        [show_objectives]
        [/show_objectives]
    [/event]

    {AH_DEATHS:HERKARTH}
    {AH_DEATHS:ULUTHUR}

    ##:: moving an unit to a rune
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                find_in=glyphs
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=gate_closed
                boolean_equals=no
            [/variable]
        [/filter_condition]

        {GLYPH_ON $x1 $y1}

        [if]
            [have_unit]
                side=1

                [filter_location]
                    find_in=glyphs
                [/filter_location]

                count=2
            [/have_unit]

            [then]
                {VARIABLE gate_closed yes}

                [message]
                    speaker=Herkarth
                    message= _ "Aha! These runes have the ability to open the gates!"
                [/message]

                [scroll_to]
                    x,y=22,15
                [/scroll_to]

                [sound]
                    name=rumble.ogg
                [/sound]

                [delay]
                    time=1500
                [/delay]

                [terrain]
                    x=21,22,23
                    y=15,15,16
                    layer=overlay
                    terrain="^"
                [/terrain]

                [redraw][/redraw]

                [delay]
                    time=2000
                [/delay]

                [message]
                    speaker=Herkarth
                    message= _ "Now we can enter the fortress! Forward!"
                [/message]
            [/then]
            [else]
                [fire_event]
                    name="AH_S5_first_rune_found"
                    [primary_unit]
                        x=$x1
                        y=$y1
                    [/primary_unit]
                [/fire_event]
            [/else]
        [/if]
    [/event]

    ##:: event of finding one rune
    [event]
        name="AH_S5_first_rune_found"
        first_time_only=yes

        [message]
            speaker=unit
            message= _ "This rune looks like it has something to do with the gates."
        [/message]
    [/event]

    ##:: merfolk leader dies
    [event]
        name="last breath"

        [filter]
            id=Elysia
        [/filter]

        [message]
            speaker="Elysia"
            message=_"You may have defeated me, drake. However, you will not have same luck with my sister, Aylarna. Your kind must be not allowed to reach the temple depths!"
        [/message]

        [message]
            speaker="Herkarth"
            message=_"You oppose us for the wrong reasons, merfolk. We have never borne any ill will towards you. We only wish to reclaim our temple and reawaken our dying flames."
        [/message]
    [/event]

    ##:: killing the dwarven leaders
    [event]
        name="last breath"

        [filter]
            side=3
            canrecruit=yes
        [/filter]

        [message]
            speaker=unit
            message=_"I hae fallen an' failed tha duty bestowed upon me by tha Underearth King!"
        [/message]
    [/event]

    [event]
        name="die"
        [filter]
            side=3
            canrecruit=yes
        [/filter]

        [if]
            [not]
                [have_unit]
                    side=2
                    canrecruit=yes
                [/have_unit]
            [/not]
            [then]
                {VARIABLE AH_S5_dwarven_leaders_killed "yes"}
            [/then]
        [/if]
    [/event]

    [event]
        name="last breath"

        [filter]
            side=2
            canrecruit=yes
        [/filter]

        [message]
            speaker=unit
            message=_"Oh, nae! tha drakes cannot be allowed ta enter their temple!"
        [/message]
    [/event]

    [event]
        name="die"
        [filter]
            side=2
            canrecruit=yes
        [/filter]

        [if]
            [not]
                [have_unit]
                    side=3
                    canrecruit=yes
                [/have_unit]
            [/not]
            [then]
                {VARIABLE AH_S5_dwarven_leaders_killed "yes"}
            [/then]
        [/if]
    [/event]

    ##:: give player warning about runic mine
    [event]
        name="enter_hex"
        first_time_only=yes

        [filter]
            side=1
            x=29,30,36,37,38,30,30,30
            y=22,22,23,24,23, 1, 2, 3
        [/filter]

        [message]
            speaker="Herkarth"
            message=_"Be Careful. I know this war tactic. The treacherous stoneheads have placed runes here and they will explode if you are within reach. Only trigger them when you absolutely have to."
        [/message]
    [/event]

    ##:: enemies defeated
    [event]
        name="enemies defeated"

        [message]
            speaker="Herkarth"
            message=_"We have secured the region and suppressed all enemies."
        [/message]

        [message]
            speaker="Uluthur"
            message=_"If we were not so preoccupied with our mission, I would say that you are the very first of the Fires of Menor to have done so in many centuries."
        [/message]
    [/event]

    # Toggles a glyph off when the player steps off it
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                [not]
                    find_in=glyphs
                [/not]
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=gate_closed
                boolean_equals=no
            [/variable]

            [have_location]
                x,y=$x2,$y2
                find_in=glyphs
            [/have_location]
        [/filter_condition]

        {GLYPH_OFF $x2 $y2}
    [/event]

    # Toggles a glyph off when the player unit on it dies
    [event]
        name=die
        first_time_only=no

        [filter]
            side=1

            [filter_location]
                find_in=glyphs
            [/filter_location]
        [/filter]

        [filter_condition]
            [variable]
                name=gate_closed
                boolean_equals=no
            [/variable]
        [/filter_condition]

        {GLYPH_OFF $x1 $y1}
    [/event]

    # event: time running low
    [event]
        name="turn 50"

        [message]
            speaker="Uluthur"
            message=_"Herkarth, I believe we should be focusing on finding the temple entrance right about now."
        [/message]
    [/event]

    # event: time over
    [event]
        name="time over"

        [remove_shroud]
            side=1
            x=1-3,39-41
            y=1-3,34-36
        [/remove_shroud]
        [redraw]
        [/redraw]

        {SCROLL_TO 3 35}
        [delay]
            time=400
        [/delay]

        # spawn some dwarves at the SW
        {GENERIC_UNIT 3 ("Bear Cavalry") 3 35}
        {GENERIC_UNIT 3 ("Bear Rider") 3 35}
        {GENERIC_UNIT 3 ("Bear Rider") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Stalwart") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Stalwart") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Stalwart") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Thunderguard") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Thunderguard") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Thunderguard") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Stalwart") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Stalwart") 3 35}
        {GENERIC_UNIT 3 ("Dwarvish Stalwart") 3 35}

        {SCROLL_TO 40 35}
        [delay]
            time=400
        [/delay]

        # spawn more at the SE
        {GENERIC_UNIT 3 ("Dwarvish Explorer") 40 35}
        {GENERIC_UNIT 3 ("Dwarvish Pathfinder") 40 35}
        {GENERIC_UNIT 3 ("Dwarvish Pathfinder") 40 35}
        {GENERIC_UNIT 3 ("Dwarvish Steelclad") 40 35}
        {GENERIC_UNIT 3 ("Dwarvish Steelclad") 40 35}
        {GENERIC_UNIT 3 ("Dwarvish Steelclad") 40 35}
        {GENERIC_UNIT 3 ("Dwarvish Bloodaxe") 40 35}

        {SCROLL_TO 2 2}
        [delay]
            time=400
        [/delay]

        # spawn more at the NW
        {GENERIC_UNIT 3 ("Gryphon Master") 2 2}
        {GENERIC_UNIT 3 ("Gryphon Rider") 2 2}
        {GENERIC_UNIT 3 ("Gryphon Rider") 2 2}
        {GENERIC_UNIT 3 ("Gryphon Rider") 2 2}

        [message]
            x,y=3,35
            message=_"We hae returned! Ah, tha drakes be here! let us rid Knalga o' their accursed kind! Onwards!"
        [/message]

        [message]
            x,y=40,35
            message=_"For tha Underearth King!"
        [/message]

        [message]
            speaker="Herkarth"
            message=_"Curses! We have delayed far too long! The stoneheads are have surrounded us! We shall all be wiped out before even setting foot inside the temple!"
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # event: scenario end
    [event]
        name=scenario_end

        {CLEAR_VARIABLE glyphs,glyph_i,locations_outside,gate_closed,AH_S5_dwarves_sighted,AH_S5_dwarven_leaders_killed}
    [/event]

    # add runic gate graphics as a macro
    # these are from SoF
    {RUNIC_GATE_TERRAIN_GRAPHICS}

    {UX_HIGHLIGHT_MISSES_EVENT}
[/scenario]
